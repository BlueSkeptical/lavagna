<div layout="column" layout-gt-sm="row">
    <div flex="66">
        <lvg-card-description card="$ctrl.card" project="$ctrl.project"></lvg-card-description>

        <div class="row">
            <div class="col-md-12">
                <div class="lavagna-card-panel lavagna-tab" data-lvg-tab-ui>
                    <div class="head clearfix tab-controls">
                        <ul class="lavagna-tab-controls">
                            <li><a href=""
                                   data-lvg-tab-ui-target="lavagna-card-panel-comments" data-translate>card.comments</a></li>
                            <li><a href=""
                                   data-lvg-tab-ui-target="lavagna-card-panel-files" data-translate>card.files</a></li>
                            <li><a href=""
                                   data-lvg-tab-ui-target="lavagna-card-panel-activity" data-translate>card.activity</a></li>
                        </ul>
                    </div>
                    <div class="lavagna-tab-panel" id="lavagna-card-panel-comments">
                        <div class="body-full" data-ng-if="$ctrl.comments.length > 0">
                            <ul class="lavagna-comments">
                                <li data-ng-repeat="comment in $ctrl.comments | orderBy: 'time' track by comment.id "
                                    class="comment" id="{{::comment.id}}" data-lvg-scroll-to-comment="comment.id">
                                    <div class="header">
                                        <span class="user" data-lvg-user-tooltip="comment.userId"></span>&nbsp;<span
                                        class="date" data-ng-bind="comment.time | dateIncremental"></span>
                                        <ul
                                            class="panel-controls">
                                            <li class="control-item"><a data-ng-href="#/{{$ctrl.project.shortName}}/{{$ctrl.board.shortName}}-{{$ctrl.card.sequence}}#{{comment.id}}" title="{{'card.permalink' | translate}}"><span class="fa fa-link"></span></a></li>
                                            <li data-lvg-has-permission="UPDATE_CARD_COMMENT" data-owner-id="comment.userId"
                                                data-ng-hide="commentControl.editComment"
                                                data-ng-click="commentControl.deleteComment = false; commentToEdit = comment.content; commentControl.editComment=true"
                                                class="control-item"><span
                                                class="fa fa-pencil" title="{{'card.hint.updateComment' | translate}}"></span></li>
                                            <li data-ng-show="commentControl.editComment"
                                                data-ng-click="commentControl.editCommentPreviewMode = false; commentControl.editComment=false"
                                                class="control-item"><span
                                                class="fa fa-times active-control" title="{{'button.cancel' | translate}}"></span></li>
                                            <li data-lvg-has-permission="DELETE_CARD_COMMENT" data-owner-id="comment.userId"
                                                data-ng-hide="commentControl.deleteComment"
                                                data-ng-click="commentControl.editCommentPreviewMode = false; commentControl.editComment=false; commentControl.deleteComment = true"
                                                class="control-item"><span
                                                class="fa fa-trash-o" title="{{'card.hint.deleteComment' | translate}}"></span></li>
                                            <li data-ng-show="commentControl.deleteComment"
                                                data-ng-click="commentControl.deleteComment = false"
                                                class="control-item"><span
                                                class="fa fa-times active-control" title="{{'button.cancel' | translate}}"></span></li>
                                        </ul>
                                        <form data-role="form" data-ng-if="commentControl.deleteComment"
                                              data-ng-submit="$ctrl.deleteComment(comment, commentControl.deleteComment)" class="panel-confirmation-control">
                                            <div class="form-group" data-translate>card.deleteThisComment</div>
                                            <div>
                                                <button type="submit" class="lvg-button lvg-button-submit" data-translate>button.yes</button>
                                                <button type="button" class="lvg-button lvg-button-default"
                                                        data-ng-click="commentControl.deleteComment = false"><span data-translate>button.no</span></button>
                                            </div>
                                        </form>
                                    </div>
                                    <div data-ng-hide="commentControl.editComment" class="content"
                                         data-ng-bind-html="comment.content | markdown"></div>
                                    <div class="content-update"
                                         data-ng-if="comment.updatedCount == 1 && !commentControl.editComment">
                                        <span data-translate>card.updateCount</span>
                                        -
                                        <span data-translate>card.lastUpdatedBy</span>
                                        <span class="user" data-lvg-user-tooltip="comment.updateUser"></span>
                                        <span data-translate>card.onDate</span>
                                        <span class="date" data-ng-bind="comment.updateDate | dateIncremental"></span>
                                    </div>
                                    <div class="content-update"
                                         data-ng-if="comment.updatedCount > 1 && !commentControl.editComment">
                                        <span data-translate data-translate-value-count="{{comment.updatedCount}}">card.updateCounts</span>
                                        -
                                        <span data-translate>card.lastUpdatedBy</span>
                                        <span class="user" data-lvg-user-tooltip="comment.updateUser"></span>
                                        <span data-translate>card.onDate</span>
                                        <span class="date" data-ng-bind="comment.updateDate | dateIncremental"></span>
                                    </div>
                                    <form data-role="form" data-ng-if="commentControl.editComment"
                                          data-ng-submit="$ctrl.updateComment(comment, commentToEdit);commentControl.editComment=false;commentControl.editCommentPreviewMode=false">
                                        <div class="form-group">
                                            <div data-ng-hide="commentControl.editCommentPreviewMode">
                                            <textarea
                                                data-ng-model="commentToEdit" class="form-control"></textarea>
                                            </div>
                                            <div data-ng-show="commentControl.editCommentPreviewMode" data-ng-bind-html="commentToEditPreview | markdown"></div>
                                        </div>
                                        <div class="form-group">
                                            <button class="lvg-button lvg-button-submit" type="submit" data-translate>button.update</button>
                                            <button class="lvg-button lvg-button-default" type="button"
                                                    data-ng-click="commentToEditPreview = commentToEdit; commentControl.editCommentPreviewMode = true"
                                                    data-ng-hide="commentControl.editCommentPreviewMode"><span data-translate>button.preview</span></button>
                                            <button class="lvg-button lvg-button-default" type="button"
                                                    data-ng-click="commentControl.editCommentPreviewMode = false"
                                                    data-ng-show="commentControl.editCommentPreviewMode"><span data-translate>button.closePreview</span></button>
                                            <button type="button" class="lvg-button lvg-button-default"
                                                    data-ng-click="commentControl.editCommentPreviewMode = false; commentControl.editComment=false"><span data-translate>button.cancel</span></button>
                                        </div>
                                    </form>
                                </li>
                            </ul>
                        </div>
                        <div class="footer" data-lvg-has-permission="CREATE_CARD_COMMENT">
                            <div class="content">
                                <form data-role="form"
                                      data-ng-submit="$ctrl.addComment(comment);previewMode = false">
                                    <div class="form-group">
                                        <div data-ng-hide="previewMode">
                                        <textarea
                                            id="comment"
                                            data-ng-model="comment.content" class="form-control"></textarea>
                                        </div>
                                        <div class="panel panel-default"
                                             data-ng-show="previewMode">
                                            <div class="panel-body"
                                                 data-ng-bind-html="editedContent | markdown"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <button type="submit" class="lvg-button lvg-button-submit" data-translate>button.add</button>
                                        <button type="button" data-ng-hide="previewMode"
                                                data-ng-click="editedContent = comment.content; previewMode = true"
                                                class="lvg-button lvg-button-default"><span data-translate>button.preview</span></button>
                                        <button type="button" data-ng-show="previewMode"
                                                data-ng-click="previewMode = false" class="lvg-button lvg-button-default"><span data-translate>button.closePreview</span></button>
                                        <button type="button"
                                                data-ng-click="comment.content = null;previewMode = false"
                                                class="lvg-button lvg-button-default"><span data-translate>button.reset</span></button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="lavagna-tab-panel" id="lavagna-card-panel-files">
                        <div class="body-full" data-ng-if="$ctrl.files">
                            <ul class="lavagna-files-list" data-ng-init="fileControls = {}">
                                <li class="lavagna-file clearfix"
                                    data-ng-repeat="file in $ctrl.files"
                                    data-ng-init="fileControls[file.cardDataId] = {}">
                                    <div class="lavagna-file-icon">
                                        <span class="fa fa-floppy-o"></span>
                                    </div>
                                    <div class="lavagna-file-info">
                                        <ul>
                                            <li class="file-info"><span class="username" data-lvg-user-tooltip="file.userId"></span>
                                                <span class="date" data-ng-bind="file.time | dateIncremental"></span></li>
                                            <li class="file-info"><a
                                                data-ng-href="api/card-data/file/{{file.cardDataId}}/{{file.name}}" target="_blank">{{file.name}}</a></li>
                                            <li class="file-info"><span class="size" data-ng-bind="file.size | fileBytes"></span></li>
                                        </ul>
                                        <form data-role="form" data-ng-if="fileControls[file.cardDataId].deleteFile"
                                              data-ng-submit="$ctrl.deleteFile(file.cardDataId)" class="panel-confirmation-control">
                                            <div class="form-group" data-translate>card.deleteThisFile</div>
                                            <div>
                                                <button type="submit" class="lvg-button lvg-button-submit" data-translate>button.yes</button>
                                                <button type="button" class="lvg-button lvg-button-default"
                                                        data-ng-click="fileControls[file.cardDataId].deleteFile = false"><span data-translate>button.no</span></button>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="lavagna-file-controls">
                                        <ul>
                                            <li data-lvg-has-permission="DELETE_FILE" data-ng-click="fileControls[file.cardDataId].deleteFile = true"
                                                data-ng-hide="fileControls[file.cardDataId].deleteFile"
                                                class="control-item"><span
                                                class="fa fa-trash-o" title="{{'button.delete' | translate}}"></span></li>
                                            <li data-lvg-has-permission="DELETE_FILE" data-ng-click="fileControls[file.cardDataId].deleteFile = false"
                                                data-ng-if="fileControls[file.cardDataId].deleteFile"
                                                class="control-item"><span
                                                class="fa fa-times active-control" title="{{'button.cancel' | translate}}"></span></li>
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="footer" data-lvg-has-permission="CREATE_FILE">
                            <div class="content">
                                <form data-role="form">
                                    <div>
                                        <div class="lvg-button lvg-button-submit"
                                             ng-file-select="$ctrl.addFiles($files)" multiple><span data-translate>button.filesSelect</span></div>
                                    </div>
                                </form>
                                <ul class="lvg-card-file-queue">
                                    <li data-ng-repeat="entry in $ctrl.filesToUpload track by $index">
                                        <div class="lavagna-file-icon">
                                        <span class="fa" data-ng-class="{'fa-clock-o': entry.status == 'queue',
                                            'fa-arrow-up': entry.status == 'upload', 'fa-stop': entry.status == 'aborted',
                                            'fa-warning': entry.status == 'failed', 'fa-check': entry.status == 'success'}"></span>
                                        </div>
                                        <div class="lavagna-file-metadata">
                                            <div class="file-name">{{entry.file.name}}</div>
                                            <div class="upload-progress progress progress-success lavagna-progress">
                                                <div class="progress-bar" data-ng-style="{'width': entry.progress + '%'}"></div>
                                            </div>
                                            <div class="file-size"><span class="size">{{entry.file.size | fileBytes}}</span></div>
                                        </div>
                                        <div class="lavagna-file-controls">
                                            <ul>
                                                <li data-ng-show="entry.status == 'failed' || entry.status == 'aborted'"
                                                    data-ng-click="$ctrl.retryUpload($index)"
                                                    class="control-item"><span
                                                    class="fa fa-repeat" title="{{'button.retry' | translate}}"></span></li>
                                                <li data-ng-show="entry.status != 'upload'"
                                                    data-ng-click="$ctrl.cancelUpload($index)"
                                                    class="control-item"><span
                                                    class="fa fa-times" title="{{'button.cancel' | translate}}"></span></li>
                                                <li data-ng-show="entry.status == 'upload'"
                                                    data-ng-click="$ctrl.abortUpload($index)"
                                                    class="control-item"><span
                                                    class="fa fa-stop" title="{{'button.abort' | translate}}"></span></li>
                                            </ul>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="lavagna-tab-panel" id="lavagna-card-panel-activity">
                        <div class="body-full">
                            <ul data-ng-if="$ctrl.hasActivity()" class="lavagna-activity">
                                <li data-ng-repeat="activity in $ctrl.activities | orderBy: '-id' track by activity.id"
                                    class="activity">
                                    <div class="header">
                                        <span class="user" data-lvg-user-tooltip="activity.userId"></span>&nbsp;<span
                                        class="date" data-ng-bind="activity.time | dateIncremental"></span>
                                    </div>
                                    <lvg-card-activity></lvg-card-activity>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div flex="33">
        <lvg-card-metadata  card="$ctrl.card" board="$ctrl.board"
                            project="$ctrl.project" user="$ctrl.user"
                            milestones="$ctrl.milestones" due-dates="$ctrl.dueDates"
                            label-values="$ctrl.labelValues" user-labels="$ctrl.userLabels"></lvg-card-metadata>

        <lvg-card-people card="$ctrl.card" project="$ctrl.project" user="$ctrl.user"
                         assigned-users="$ctrl.assignedUsers" watching-users="$ctrl.watchingUsers"></lvg-card-people>

        <lvg-card-action-lists card="$ctrl.card" action-lists="$ctrl.actionLists"></lvg-card-action-lists>
    </div>
</div>
